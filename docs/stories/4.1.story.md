# 4.1 — CSV/XLSX Export with Schema Validation

## Status
Approved

## Story
**As a** system,
**I want** to export validated cheque data to CSV/XLSX with schema checks,
**so that** downstream processes can consume it reliably.

## Acceptance Criteria
1. CSV and XLSX export formats implemented with headers and types.
2. Only validated, approved cheques included.
3. Schema validation runs before writing files.

## Dev Notes (Architecture References)
- Export [Source: architecture/components.md#9-export-integration]
- PRD export requirements [Source: prd/2-requirements.md#functional-requirements]
- Coding standards [Source: architecture/coding-standards.md]

### Testing
- Test file location: `backend/tests/services/test_exporter.py`
- Standards: follow `docs/architecture/coding-standards.md`; target ≥ 85% coverage on core logic
- Frameworks: `pytest`
- Story-specific: schema validation prior to write; only approved cheques included per `testing-strategy.md`

## Tasks / Subtasks
- [x] Implement export module `backend/app/services/exporter.py`.
- [x] Schema definitions and validators.
- [x] Tests for CSV/XLSX correctness.

## Project Structure Notes
- Keep file I/O isolated; core logic testable without filesystem.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-16 | 0.1 | Initial exporter (CSV/XLSX) with schema validation and tests | James (dev) |

## Dev Agent Record
### Agent Model Used
Cascade

### Debug Log References
- Implemented exporter with CSV/XLSX writers and schema gate in `backend/app/services/exporter.py`.
- Added dependency `openpyxl>=3.1` in `backend/pyproject.toml` for XLSX support.
- Added tests in `backend/tests/services/test_exporter.py` to verify filtering, headers, and data rows.

### Completion Notes List
- Exporter gathers only approved and validated items, then writes CSV/XLSX with headers `bank,file,date,cheque_number,amount_numeric,name,stp,overall_conf`.
- Schema validation ensures required fields are present and non-empty (preferring `parse_norm`, falling back to `ocr_text`).
- XLSX export uses `openpyxl`; CSV uses Python `csv` module.

### File List
- backend/app/services/exporter.py (new)
- backend/tests/services/test_exporter.py (new)
- backend/pyproject.toml (modified: add openpyxl)

## QA Results

