# 2.3 — Auto-approve vs Human Review Routing + Logging

## Status
In Progress

## Story
**As a** system,
**I want** to route cheques to auto-approve when all gates pass and confidences exceed threshold, otherwise to human review,
**so that** I can record structured reasons for decisions and guarantee correctness.

## Acceptance Criteria
1. If all required fields ≥ threshold and validations pass → auto-approve and mark `stp=true`.
2. Else → route to human review with reason codes and low-confidence field list.
3. All decisions logged with correlation IDs and persisted in audit JSON.
4. Unit tests cover routing branches; integration tests verify end-to-end behavior.

## Dev Notes (Architecture References)
- Confidence & Routing [Source: architecture/components.md#7-confidence-routing]
- Human-in-the-Loop [Source: architecture/components.md#8-human-in-the-loop-ui]
- Data model `cheque.status`, `cheque.audit_json`, `cheque.stp` [Source: architecture/data-model-core-tables.md#cheque]
- Coding standards & logging [Source: architecture/coding-standards.md]
- Testing [Source: architecture/testing-strategy.md]

### Testing
- Test file location: `backend/tests/services/test_routing.py`
- Standards: follow `docs/architecture/coding-standards.md`; target ≥ 85% coverage on routing logic
- Frameworks: `pytest`
- Story-specific: verify both branches (auto-approve vs review) and audit JSON content per `testing-strategy.md`

## Tasks / Subtasks
- [x] Implement router `backend/app/services/routing.py` with auto-approve and review branches.
- [x] Add optional audit JSON writer in aggregator; full persistence layer still pending.
- [x] Tests under `backend/tests/services/test_routing.py` (unit) — passing.

## Project Structure Notes
- Keep routing logic isolated from UI; UI consumes routing outcomes.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-15 | 0.1.0 | Created routing module with decision + reasons and unit tests | dev-agent |
| 2025-09-15 | 0.2.0 | Added standalone aggregator tool to compute per-image routing decisions from field CSV | dev-agent |
| 2025-09-15 | 0.3.0 | Aggregator now supports writing per-image audit JSON files | dev-agent |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List
- backend/app/services/routing.py (new)
- backend/app/services/__init__.py (new)
- backend/tests/services/test_routing.py (new)
 - backend/tools/pipeline_route_summary.py (new)

## QA Results

