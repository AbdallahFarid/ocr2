# 2.2 — Confidence Calculation and Thresholding

## Status
In Progress

## Story
**As a** system,
**I want** to compute field-level confidences and apply a global threshold,
**so that** I can auto-approve only highly reliable cheques and route the rest to review.

## Acceptance Criteria
1. Field confidence = OCR confidence × locator confidence × parse pass (1.0 if parse ok else < threshold).
2. Global threshold configurable; default 0.995 as per PRD.
3. Confidence per field is persisted with provenance.
4. Unit tests verify calculation for various combinations; integration tests validate full pipeline behavior.

## Dev Notes (Architecture References)
- Confidence & Routing [Source: architecture/components.md#7-confidence-routing]
- PRD thresholds [Source: prd/2-requirements.md#functional-requirements]
- Data model `cheque_fields.confidence` [Source: architecture/data-model-core-tables.md#cheque_fields]
- Coding standards [Source: architecture/coding-standards.md]
- Testing [Source: architecture/testing-strategy.md]

### Testing
- Test file location: `backend/tests/validations/test_confidence.py`
- Standards: follow `docs/architecture/coding-standards.md`; target ≥ 85% coverage on core logic
- Frameworks: `pytest`
- Story-specific: verify multiplicative confidence and threshold behavior per `testing-strategy.md`

## Tasks / Subtasks
- [x] Implement confidence computation utility `backend/app/validations/confidence.py`.
- [ ] Persist confidences in `cheque_fields` records.
- [x] Add configuration for global threshold, default 0.995 (see `app.config.ConfidenceSettings`).
- [x] Tests in `backend/tests/validations/test_confidence.py` and CSV integration via `backend/tools/pipeline_eval.py`.

## Project Structure Notes
- Keep computation deterministic and pure; avoid hidden I/O in functions.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-15 | 0.1.0 | Added confidence settings, field confidence computation, tests, and CSV output columns (`field_conf`, `meets_threshold`) | dev-agent |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List
 - backend/app/config.py (updated: `ConfidenceSettings`, `DEFAULT_CONFIDENCE`)
 - backend/app/validations/confidence.py (new)
 - backend/tests/validations/test_confidence.py (new)
 - backend/tools/pipeline_eval.py (updated: confidence columns)

## QA Results

